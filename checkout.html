<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout â€” Posana</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/" onerror="console.warn('Failed to load Stripe.js - payment form will use demo mode')"></script>
    <style>
        /* Stripe-style Checkout Design */
        body {
            background: #ffffff;
            padding: 0;
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #1a1a1a;
            line-height: 1.5;
        }

        .checkout-wrapper {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .checkout-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e6e6e6;
            background: #ffffff;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .checkout-header-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .checkout-logo {
            height: 28px;
            width: auto;
        }

        .checkout-main-container {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 32px 24px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 64px;
            align-items: start;
        }

        .checkout-form-wrapper {
            max-width: 560px;
        }

        .checkout-title {
            font-size: 28px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 32px;
            letter-spacing: -0.02em;
        }

        .checkout-section {
            margin-bottom: 32px;
        }

        .checkout-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-link {
            font-size: 13px;
            color: #006aff;
            text-decoration: none;
            font-weight: 500;
        }

        .section-link:hover {
            text-decoration: underline;
        }

        .stripe-form-group {
            margin-bottom: 16px;
        }

        .stripe-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
            color: #1a1a1a;
            background: #ffffff;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .stripe-input:focus {
            outline: none;
            border-color: #006aff;
            box-shadow: 0 0 0 3px rgba(0, 106, 255, 0.1);
        }

        .stripe-input::placeholder {
            color: #9ca3af;
        }

        .form-row-stripe {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-row-three-stripe {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-wrapper label {
            font-size: 14px;
            color: #4b5563;
            cursor: pointer;
        }

        .shipping-options {
            margin-top: 12px;
        }

        .shipping-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: border-color 0.15s, background-color 0.15s;
        }

        .shipping-option:hover {
            border-color: #d1d5db;
        }

        .shipping-option input[type="radio"] {
            margin-right: 12px;
            cursor: pointer;
        }

        .shipping-option label {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
        }

        .shipping-name {
            font-weight: 500;
            color: #1a1a1a;
        }

        .shipping-price {
            font-weight: 600;
            color: #1a1a1a;
        }

        .shipping-placeholder {
            padding: 16px;
            background: #f9fafb;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            color: #6b7280;
        }

        .payment-form-wrapper {
            margin-top: 16px;
        }

        .stripe-card-element {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #ffffff;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .stripe-card-element:focus-within {
            border-color: #006aff;
            box-shadow: 0 0 0 3px rgba(0, 106, 255, 0.1);
        }

        .card-errors {
            color: #dc2626;
            font-size: 13px;
            margin-top: 8px;
            min-height: 20px;
        }

        .submit-button {
            width: 100%;
            padding: 14px 24px;
            background: #006aff;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background-color 0.15s;
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .submit-button:hover:not(:disabled) {
            background: #0052cc;
        }

        .submit-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .spinner.hidden {
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .order-summary-sticky {
            position: sticky;
            top: 80px;
            align-self: start;
        }

        .order-summary-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 24px;
            border: 1px solid #e6e6e6;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            letter-spacing: -0.01em;
        }

        .order-items {
            margin-bottom: 20px;
        }

        .order-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e6e6e6;
        }

        .order-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            background: #e6e6e6;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .item-variant {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .item-quantity {
            font-size: 13px;
            color: #6b7280;
        }

        .item-price {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            text-align: right;
        }

        .discount-section {
            margin-bottom: 20px;
        }

        .discount-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .discount-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .discount-button {
            padding: 10px 16px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: border-color 0.15s;
        }

        .discount-button:hover {
            border-color: #9ca3af;
        }

        .price-breakdown {
            padding-top: 20px;
            border-top: 1px solid #e6e6e6;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #4b5563;
            margin-bottom: 12px;
        }

        .price-row:last-of-type {
            margin-bottom: 0;
        }

        .price-row-total {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            padding-top: 16px;
            border-top: 1px solid #e6e6e6;
            margin-top: 16px;
        }

        .empty-cart {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-cart-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-cart h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .empty-cart p {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .btn-shop-now {
            display: inline-block;
            padding: 10px 20px;
            background: #006aff;
            color: #ffffff;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        @media (max-width: 968px) {
            .checkout-main-container {
                grid-template-columns: 1fr;
                gap: 32px;
            }

            .order-summary-sticky {
                position: relative;
                top: 0;
            }
        }

        @media (max-width: 640px) {
            .checkout-header {
                padding: 16px;
            }

            .checkout-main-container {
                padding: 24px 16px;
                gap: 24px;
            }

            .form-row-stripe,
            .form-row-three-stripe {
                grid-template-columns: 1fr;
            }

            .checkout-title {
                font-size: 24px;
                margin-bottom: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="checkout-wrapper">
        <!-- Minimal Header -->
        <header class="checkout-header">
            <div class="checkout-header-inner">
                <a href="index.html">
                    <img src="https://eatposana.com/cdn/shop/files/logo_new_e4990b7c-e496-4582-b93c-a1f8a7928409.png?v=1738559624&width=360" alt="Posana" class="checkout-logo">
                </a>
            </div>
        </header>

        <!-- Main Checkout Container -->
        <div class="checkout-main-container">
            <!-- Left: Checkout Form -->
            <div class="checkout-form-wrapper">
                <h1 class="checkout-title">Checkout</h1>

                <!-- Contact Section -->
                <div class="checkout-section">
                    <div class="section-header-row">
                        <h2 class="checkout-section-title">Contact</h2>
                        <a href="#" class="section-link">Sign in</a>
                    </div>
                    <div class="stripe-form-group">
                        <input type="text" class="stripe-input" placeholder="Email or mobile phone number" id="contactEmail" required>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="emailNews" class="checkbox">
                        <label for="emailNews">Email me with news and offers</label>
                    </div>
                </div>

                <!-- Delivery Section -->
                <div class="checkout-section">
                    <h2 class="checkout-section-title">Delivery</h2>
                    <div class="stripe-form-group">
                        <select class="stripe-input" id="country">
                            <option value="US" selected>United States</option>
                            <option value="CA">Canada</option>
                        </select>
                    </div>
                    <div class="form-row-stripe">
                        <div class="stripe-form-group">
                            <input type="text" class="stripe-input" placeholder="First name (optional)" id="firstName">
                        </div>
                        <div class="stripe-form-group">
                            <input type="text" class="stripe-input" placeholder="Last name" id="lastName" required>
                        </div>
                    </div>
                    <div class="stripe-form-group">
                        <input type="text" class="stripe-input" placeholder="Address" id="address" required>
                    </div>
                    <div class="stripe-form-group">
                        <input type="text" class="stripe-input" placeholder="Apartment, suite, etc. (optional)" id="apartment">
                    </div>
                    <div class="form-row-three-stripe">
                        <div class="stripe-form-group">
                            <input type="text" class="stripe-input" placeholder="City" id="city" required>
                        </div>
                        <div class="stripe-form-group">
                            <select class="stripe-input" id="state">
                                <option value="CA" selected>California</option>
                                <option value="NY">New York</option>
                                <option value="TX">Texas</option>
                                <option value="FL">Florida</option>
                            </select>
                        </div>
                        <div class="stripe-form-group">
                            <input type="text" class="stripe-input" placeholder="ZIP code" id="zipCode" required>
                        </div>
                    </div>
                </div>

                <!-- Shipping Method -->
                <div class="checkout-section">
                    <h2 class="checkout-section-title">Shipping method</h2>
                    <div class="shipping-options" id="shippingMethods">
                        <div class="shipping-placeholder">
                            Enter your shipping address to view available shipping methods.
                        </div>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="checkout-section">
                    <h2 class="checkout-section-title">Payment</h2>
                    <div class="payment-form-wrapper">
                        <form id="payment-form">
                            <div id="card-element" class="stripe-card-element">
                                <!-- Stripe Card Element will be inserted here -->
                            </div>
                            <div id="card-errors" class="card-errors" role="alert"></div>
                            
                            <button type="button" id="submit-payment" class="submit-button" onclick="redirectToStripeCheckout()">
                                <span id="button-text">Complete order</span>
                                <span id="spinner" class="spinner hidden"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right: Order Summary -->
            <div class="order-summary-sticky">
                <div class="order-summary-card">
                    <h2 class="summary-title">Order summary</h2>
                    
                    <div class="order-items" id="cartItems">
                        <!-- Items will be populated by JavaScript -->
                    </div>

                    <div class="discount-section">
                        <div class="discount-input-wrapper">
                            <input type="text" class="discount-input" placeholder="Discount code" id="discountCode">
                            <button class="discount-button" id="applyDiscount" type="button">Apply</button>
                        </div>
                    </div>

                    <div class="price-breakdown">
                        <div class="price-row">
                            <span>Subtotal</span>
                            <span id="subtotal">$35.99</span>
                        </div>
                        <div class="price-row">
                            <span>Shipping</span>
                            <span id="shipping">Enter shipping address</span>
                        </div>
                        <div class="price-row price-row-total">
                            <span>Total</span>
                            <span id="total">USD $35.99</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Load cart from localStorage
        let cart = JSON.parse(localStorage.getItem('posanaCart')) || [];
        
        // Product data
        const products = {
            'cinnavanilla': {
                name: 'Cinnavanilla Protein Bar (12-Pack)',
                price: 35.99,
                originalPrice: 42.00,
                image: 'img/Cinnavanilla 6x6 Wrapper Single Both v2 (1).png'
            },
            'matcha': {
                name: 'Posana Matcha Latte (12-pack)',
                price: 35.99,
                originalPrice: 42.00,
                image: 'https://eatposana.com/cdn/shop/files/Matcha6x6WrapperSingleBothv2_b4d80604-9758-4181-b53c-032fc6c0551d.png?v=1748830550&width=720'
            },
            'mango': {
                name: 'Posana Mango Coconut (with Turmeric)',
                price: 35.99,
                originalPrice: 42.00,
                image: 'https://eatposana.com/cdn/shop/files/Mango6x6WrapperSingleBothv2.png?v=1752730066&width=720'
            }
        };

        // Render cart items
        function renderCartItems() {
            const cartItemsContainer = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <div class="empty-cart-icon">ðŸ›’</div>
                        <h3>Your cart is empty</h3>
                        <p>Add some delicious protein bars to get started!</p>
                        <a href="index.html#shop" class="btn-shop-now">Shop Now</a>
                    </div>
                `;
                document.getElementById('subtotal').textContent = '$0.00';
                document.getElementById('total').textContent = 'USD $0.00';
                return;
            }

            cartItemsContainer.innerHTML = cart.map(item => {
                const product = products[item.id];
                return `
                    <div class="order-item">
                        <img src="${product.image}" alt="${product.name}" class="item-image">
                        <div class="item-details">
                            <div class="item-name">${product.name}</div>
                            <div class="item-variant">12-Pack</div>
                            <div class="item-quantity">Quantity: ${item.quantity}</div>
                        </div>
                        <div class="item-price">$${(product.price * item.quantity).toFixed(2)}</div>
                    </div>
                `;
            }).join('');

            updateTotals();
        }

        // Update totals
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => {
                return sum + (products[item.id].price * item.quantity);
            }, 0);

            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            
            const shipping = document.getElementById('shipping');
            
            if (subtotal >= 30) {
                shipping.textContent = 'Free';
                document.getElementById('total').textContent = `USD $${subtotal.toFixed(2)}`;
            } else if (shipping.textContent === 'Enter shipping address') {
                document.getElementById('total').textContent = `USD $${subtotal.toFixed(2)}`;
            } else {
                const shippingCost = parseFloat(shipping.textContent.replace('$', '')) || 0;
                document.getElementById('total').textContent = `USD $${(subtotal + shippingCost).toFixed(2)}`;
            }
        }

        // Handle address input to show shipping methods
        document.getElementById('zipCode').addEventListener('blur', function() {
            const zipCode = this.value;
            const shippingMethods = document.getElementById('shippingMethods');
            const shipping = document.getElementById('shipping');
            
            if (zipCode && zipCode.length >= 5) {
                shippingMethods.innerHTML = `
                    <div class="shipping-option">
                        <input type="radio" name="shipping" id="standard" value="5.99" checked>
                        <label for="standard">
                            <span class="shipping-name">Standard shipping</span>
                            <span class="shipping-price">$5.99</span>
                        </label>
                    </div>
                    <div class="shipping-option">
                        <input type="radio" name="shipping" id="express" value="12.99">
                        <label for="express">
                            <span class="shipping-name">Express shipping</span>
                            <span class="shipping-price">$12.99</span>
                        </label>
                    </div>
                `;

                // Update shipping when method changes
                document.querySelectorAll('input[name="shipping"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        const subtotal = cart.reduce((sum, item) => {
                            return sum + (products[item.id].price * item.quantity);
                        }, 0);
                        
                        if (subtotal >= 30) {
                            shipping.textContent = 'Free';
                            document.getElementById('total').textContent = `USD $${subtotal.toFixed(2)}`;
                        } else {
                            shipping.textContent = `$${this.value}`;
                            document.getElementById('total').textContent = `USD $${(subtotal + parseFloat(this.value)).toFixed(2)}`;
                        }
                    });
                });

                // Set default shipping
                const subtotal = cart.reduce((sum, item) => {
                    return sum + (products[item.id].price * item.quantity);
                }, 0);
                
                if (subtotal >= 30) {
                    shipping.textContent = 'Free';
                } else {
                    shipping.textContent = '$5.99';
                    document.getElementById('total').textContent = `USD $${(subtotal + 5.99).toFixed(2)}`;
                }
            }
        });

        // Handle discount code
        document.getElementById('applyDiscount').addEventListener('click', function() {
            const code = document.getElementById('discountCode').value.trim().toUpperCase();
            
            if (code === 'CASUELA' || code === 'FIRST15' || code === 'WELCOME15') {
                const subtotal = cart.reduce((sum, item) => {
                    return sum + (products[item.id].price * item.quantity);
                }, 0);
                
                const discount = subtotal * 0.15;
                const newTotal = subtotal - discount;
                
                // Add discount row if it doesn't exist
                const priceBreakdown = document.querySelector('.price-breakdown');
                const existingDiscount = document.getElementById('discountRow');
                
                if (existingDiscount) {
                    existingDiscount.remove();
                }
                
                const discountRow = document.createElement('div');
                discountRow.id = 'discountRow';
                discountRow.className = 'price-row';
                discountRow.innerHTML = `
                    <span>Discount (${code})</span>
                    <span style="color: #059669;">-$${discount.toFixed(2)}</span>
                `;
                
                priceBreakdown.insertBefore(discountRow, priceBreakdown.querySelector('.price-row-total'));
                
                const shippingText = document.getElementById('shipping').textContent;
                const shippingCost = shippingText === 'Free' || shippingText === 'Enter shipping address' ? 0 : parseFloat(shippingText.replace('$', ''));
                
                document.getElementById('total').textContent = `USD $${(newTotal + shippingCost).toFixed(2)}`;
                
                this.textContent = 'Applied';
                this.style.background = '#059669';
                this.style.color = '#ffffff';
            } else {
                alert('Invalid discount code');
            }
        });

        // Initialize Stripe
        let stripe, elements, cardElement;
        
        document.addEventListener('DOMContentLoaded', function() {
            renderCartItems();
            
            // Initialize Stripe if available
            if (typeof Stripe !== 'undefined') {
                try {
                    const stripeKey = 'pk_test_51QdKyMRtcXglZkO3IYWJCOZKhKu7Zr8hW0qoGG8rMJjQX6jPxhX9xhOiP0yZ9fZmOZlP8hxOGjN8hYZ7yZ8xH00Placeholder';
                    
                    if (!stripeKey.includes('Placeholder')) {
                        stripe = Stripe(stripeKey);
                        elements = stripe.elements({
                            appearance: {
                                theme: 'stripe',
                                variables: {
                                    colorPrimary: '#006aff',
                                    colorBackground: '#ffffff',
                                    colorText: '#1a1a1a',
                                    colorDanger: '#dc2626',
                                    fontFamily: 'Inter, system-ui, sans-serif',
                                    spacingUnit: '4px',
                                    borderRadius: '6px'
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.warn('Stripe initialization failed:', error);
                }
            }

            // Create and mount card element
            if (elements && stripe) {
                try {
                    cardElement = elements.create('card');
                    cardElement.mount('#card-element');
                    
                    cardElement.on('change', function(event) {
                        const displayError = document.getElementById('card-errors');
                        if (event.error) {
                            displayError.textContent = event.error.message;
                        } else {
                            displayError.textContent = '';
                        }
                    });
                } catch (error) {
                    console.warn('Failed to create Stripe card element:', error);
                }
            } else {
                // Demo mode placeholder
                const cardElementDiv = document.getElementById('card-element');
                if (cardElementDiv) {
                    cardElementDiv.innerHTML = `
                        <div style="padding: 12px; color: #6b7280; font-size: 14px;">
                            Card details will appear here when Stripe is configured
                        </div>
                    `;
                }
            }
        });

        // Redirect to Stripe Checkout
        window.redirectToStripeCheckout = function() {
            const email = document.getElementById('contactEmail').value;
            const lastName = document.getElementById('lastName').value;
            const address = document.getElementById('address').value;
            const city = document.getElementById('city').value;
            const zipCode = document.getElementById('zipCode').value;

            if (!email || !lastName || !address || !city || !zipCode) {
                alert('Please fill in all required fields before completing your order.');
                return;
            }

            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            const submitButton = document.getElementById('submit-payment');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');
            
            submitButton.disabled = true;
            buttonText.textContent = 'Redirecting...';
            spinner.classList.remove('hidden');

            const subtotal = cart.reduce((sum, item) => {
                return sum + (products[item.id].price * item.quantity);
            }, 0);

            const shippingText = document.getElementById('shipping').textContent;
            const shippingCost = shippingText === 'Free' || shippingText === 'Enter shipping address' ? 0 : parseFloat(shippingText.replace('$', ''));
            
            const total = subtotal + shippingCost;

            const cartData = {
                items: cart.map(item => ({
                    id: item.id,
                    name: products[item.id].name,
                    quantity: item.quantity,
                    price: products[item.id].price
                })),
                email: email,
                shipping: {
                    name: `${document.getElementById('firstName').value || ''} ${lastName}`.trim(),
                    address: address,
                    city: city,
                    state: document.getElementById('state').value,
                    zip: zipCode,
                    country: document.getElementById('country').value,
                    cost: shippingCost
                },
                total: total
            };

            fetch('/create-checkout-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cartData)
            })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(data => {
                        throw new Error(data.error || 'Failed to create checkout session');
                    });
                }
                return res.json();
            })
            .then(data => {
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    throw new Error('No checkout URL received');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error processing checkout: ' + error.message + '\n\nPlease check that your Stripe key is set up correctly.');
                submitButton.disabled = false;
                buttonText.textContent = 'Complete order';
                spinner.classList.add('hidden');
            });
        };
    </script>
</body>
</html>
